<!DOCTYPE html>
<html>

<body>

    <h2>My First JavaScript</h2>

    <script>
        const blocks = 64 // Number of blocks to read

        function download(filename) {
            var element = document.createElement('a');
            let array = new Array(blocks)

            const nfc = document.getElementById("nfc");
            var text = nfc.value.split("\n");

            const re = /Block (\d+): (([0-9a-fA-F]+ *)+)/gm
            for (let i = 0; i < text.length; i++) {
                const data = re.exec(text)
                console.log(data)
                if (data) {
                    const block = parseInt(data[1])
                    const bytes = data[2].replace(/ /g, '')
                    console.log(block, bytes)
                    if (block < blocks) {
                        console.log('block', block, bytes)
                        array[block] = bytes
                    }
                }
            }
            let textHex = ""
            for (let i = 0; i < blocks; i++) {
                console.log('block', i, array[i])
                if (array[i] !== undefined && array[i]?.length==32) {
                    textHex += array[i]
                    console.log("Writing block", i, array[i], "to text")
                } else {
                    console.log('block', i, 'is empty')
                    //Filling with 0 if block is empty
                    textHex += '00000000000000000000000000000000'
                }
            }

            var filename = Date.now() + ".bin"
            console.log(textHex)
        
        var bin = new Array();
        for (var i=0; i<textHex.length/2; i++) {
          var h = textHex.substr(i*2, 2);
          bin[i] = parseInt(h,16);        
        }
  
          var byteArray = new Uint8Array(bin);
          var a = window.document.createElement('a');
  
          a.href = window.URL.createObjectURL(new Blob([byteArray], { type: 'application/octet-stream' }));
          a.download = filename;
  
          // Append anchor to body.
          document.body.appendChild(a)
          a.click();
  
          // Remove anchor from body
          document.body.removeChild(a)
        }

    </script>


    <button type="button" onclick="download('data.bin');">
        Click me to download your file</button>
    <p>Paste your .nfc file content here</p>
    <br />
    <textarea id="nfc" rows="20" cols="50"></textarea>

</body>

</html>